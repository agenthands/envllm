# EnvLLM-DSL v0.2.2: Schema, Flow, and Strictness

**Target:** Eliminate hallucination and variable shadowing errors.
**Date:** 2026-02-16

## 1. Type System Upgrade (Schema vs JSON)

We replace generic `JSON` usage with typed Structs for core runtime objects.

### New Types
- **`STRUCT<T>`**: A named record with a fixed set of typed fields.
- **`ROWS<T>`**: A list of `STRUCT<T>` records (Anka-style table).

### Canonical Schemas (Minimal Set)
1.  **`VmStats`**
    - `cost`: `COST`
    - `steps`: `INT`
    - `elapsed_ms`: `INT`
2.  **`Span`** (Already exists, formalized as struct)
    - `start`: `OFFSET`
    - `end`: `OFFSET`
3.  **`LogHit`**
    - `offset`: `OFFSET`
    - `content`: `TEXT`

### New Operations
- `GET_FIELD SOURCE <STRUCT> FIELD <string> INTO <Any>`
  - Replaces `JSON_GET` for known types.
  - Linter enforces `FIELD` validity against the Struct's schema.
- `GET_ROW SOURCE <ROWS> INDEX <INT> INTO <STRUCT>`
  - Extracts a record from a table.

## 2. Control Flow: Restricted Iteration

Address the recursion overhead by adding a bounded loop.

### Syntax
```ebnf
for_loop = "FOR_EACH", req_ws, ident, req_ws, "IN", req_ws, ident, req_ws, "LIMIT", req_ws, int, ":", line_end, { stmt_line } ;
```

### Constraints (Strict Mode)
- **Bounded**: `LIMIT` is mandatory.
- **Scope**: Loop variable is read-only.
- **Complexity**: No nested `FOR_EACH`. No `SUBCALL` inside loop (unless capability explicitly allowed).

## 3. Strictness Rules (Linter)

### LINT_VAR_REUSE_FORBIDDEN
- **Rule**: A variable name (e.g., `out`) cannot be defined more than once in a program.
- **Fix Hint**: "Rename to `out_2` or `out_step3`."

### LINT_JSON_USAGE
- **Rule**: Warn/Error if `JSON_GET` is used on a variable known to be a `STRUCT`.
- **Fix Hint**: "Use `GET_FIELD` or specialized getter (e.g., `GET_COST`) for this type."

## 4. Implementation Plan

1.  **Runtime**: Add `KindStruct`, `KindRows`. Update `Value` to hold schema info.
2.  **Ops**: Add `GET_FIELD`, `GET_ROW`. Update `STATS` to return `VmStats`.
3.  **Linter**: Implement symbol table tracking for Shadowing and Schema validation.
4.  **Parser**: Add `FOR_EACH` grammar.
